name: Claude Code Review with Bedrock

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: false
        type: number

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write  # Required for AWS OIDC authentication

jobs:
  claude-review:
    runs-on: ubuntu-latest
    name: Review code with Claude Sonnet 4.5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          pip install anthropic boto3
      
      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
          else
            PR_NUMBER=${{ inputs.pr_number }}
          fi
          
          if [ -n "$PR_NUMBER" ]; then
            # Get the diff for the PR
            git fetch origin pull/$PR_NUMBER/head:pr-branch
            git diff origin/${{ github.base_ref }}...pr-branch > /tmp/diff.txt
            echo "diff_file=/tmp/diff.txt" >> $GITHUB_OUTPUT
          else
            # No PR number provided, set empty diff_file
            echo "diff_file=" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Claude Code Review
        env:
          DIFF_FILE: ${{ steps.changed-files.outputs.diff_file }}
        run: |
          python - <<'PYTHON_SCRIPT'
          import os
          import anthropic
          from pathlib import Path
          
          # Initialize Bedrock client - credentials auto-configured via AWS role
          client = anthropic.AnthropicBedrock(
              aws_region=os.getenv("AWS_REGION", "us-east-1")
          )
          
          # Read the diff file from environment variable
          diff_file = os.getenv("DIFF_FILE", "")
          if not diff_file:
              print("No PR number provided for review")
              exit(0)
          
          if diff_file and Path(diff_file).exists():
              with open(diff_file, 'r') as f:
                  diff_content = f.read()
              
              if not diff_content.strip():
                  print("No changes to review")
                  exit(0)
              
              # Prepare the review prompt
              prompt = f"""Review the following code changes and provide constructive feedback:

          {diff_content}

          Please provide:
          1. A brief summary of the changes
          2. Any potential issues or bugs
          3. Security concerns if any
          4. Suggestions for improvement
          5. Code quality and best practices feedback

          Be concise and focus on the most important points."""
              
              # Call Claude Sonnet 4.5 via Bedrock
              response = client.messages.create(
                  model="global.anthropic.claude-sonnet-4-20250514-v1:0",
                  max_tokens=2000,
                  temperature=0,
                  messages=[
                      {"role": "user", "content": prompt}
                  ]
              )
              
              review_text = response.content[0].text
              
              # Save review to file for next step
              with open('/tmp/review.txt', 'w') as f:
                  f.write(review_text)
              
              print("Review completed successfully")
              print("\n--- Claude's Review ---")
              print(review_text)
          else:
              print("No diff file found or no changes to review")
          PYTHON_SCRIPT
      
      - name: Post review comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reviewPath = '/tmp/review.txt';
            
            if (fs.existsSync(reviewPath)) {
              const review = fs.readFileSync(reviewPath, 'utf8');
              
              const comment = `## ðŸ¤– Claude Sonnet 4.5 Code Review\n\n${review}\n\n---\n*Powered by AWS Bedrock with Claude Sonnet 4.5*`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              console.log('No review file found');
            }
